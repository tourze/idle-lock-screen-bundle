# 无操作锁屏功能开发文档

## 工作内容概述

### 1. 需求背景

为 Symfony 应用开发无操作锁屏功能，当用户在敏感页面（如账单页）超过指定时间无操作时，自动跳转到密码验证页面，确保数据安全。该功能需要支持灵活的页面配置、完整的锁定记录追踪，以及无侵入式的前端集成。

### 2. 核心功能

- 支持基于路由规则的页面锁定配置（支持通配符匹配）
- 可配置的无操作超时时间（默认1分钟）
- 自动检测用户活动状态（鼠标移动、键盘输入、点击等）
- 锁定状态持久化存储，防止用户绕过验证
- 密码验证解锁机制
- 完整的锁定/解锁记录日志
- 后台管理界面查看锁定记录
- 无侵入式 Twig 模板集成

### 3. 技术范围

- **后端技术**：PHP 8.1+、Symfony 6.4+、Doctrine ORM
- **前端技术**：JavaScript、Twig 模板引擎
- **数据库**：MySQL/PostgreSQL（通过 Doctrine DBAL）
- **缓存**：Symfony Cache 组件
- **安全**：Symfony Security 组件

## 任务拆分与进度计划

| 任务阶段 | 具体任务项 | 优先级 | 预估耗时 | 进度状态（⏳/🔄/✅） | 责任人 |
|---------|-----------|--------|----------|---------------------|--------|
| 需求分析 | 1. 设计数据库表结构（锁定配置、锁定记录） | P0 | 2h | ✅ | AI 工具 |
|          | 2. 梳理业务流程图（锁定触发、验证解锁） | P0 | 1h | ✅ | AI 工具 |
| 架构设计 | 1. 设计 Bundle 整体架构和服务依赖 | P0 | 3h | ✅ | AI 工具 |
|          | 2. 设计 Twig 扩展和 JavaScript 集成方案 | P0 | 2h | ✅ | AI 工具 |
|          | 3. 设计配置文件结构和验证规则 | P1 | 1h | ✅ | AI 工具 |
| 核心实现 | 1. 创建 Entity 类（LockConfiguration、LockRecord） | P0 | 2h | ✅ | AI 工具 |
|          | 2. 实现锁定检测服务（IdleLockDetector） | P0 | 3h | ✅ | AI 工具 |
|          | 3. 实现锁定管理服务（LockManager） | P0 | 3h | ✅ | AI 工具 |
|          | 4. 创建路由匹配器（RoutePatternMatcher） | P0 | 2h | ✅ | AI 工具 |
| 前端集成 | 1. 开发 Twig 扩展（注入 JavaScript 代码） | P0 | 3h | ✅ | AI 工具 |
|          | 2. 实现前端活动检测 JavaScript | P0 | 4h | ✅ | AI 工具 |
|          | 3. 创建密码验证页面模板 | P0 | 2h | ✅ | AI 工具 |
| 控制器层 | 1. 实现锁定验证控制器 | P0 | 2h | ✅ | AI 工具 |
|          | 2. 实现解锁验证控制器 | P0 | 2h | ✅ | AI 工具 |
|          | 3. 实现后台管理控制器 | P1 | 3h | ⏳ | AI 工具 |
| 中间件层 | 1. 创建锁定检查中间件（Kernel Event Listener） | P0 | 3h | ✅ | AI 工具 |
|          | 2. 实现会话状态管理 | P0 | 2h | ✅ | AI 工具 |
| 配置管理 | 1. 实现 Bundle 配置类 | P1 | 2h | ⏳ | AI 工具 |
|          | 2. 创建默认配置文件 | P1 | 1h | ✅ | AI 工具 |
| 测试验收 | 1. 编写单元测试（服务层） | P1 | 4h | ⏳ | AI 工具 |
|          | 2. 编写功能测试（控制器层） | P1 | 3h | ⏳ | AI 工具 |
|          | 3. 编写集成测试（完整流程） | P1 | 2h | ⏳ | AI 工具 |

## 验收条件清单

### 1. 功能验收

- 用户在配置的敏感页面超时后自动跳转到锁定页面
- 锁定状态在用户尝试绕过时仍然有效（刷新、返回、重新访问）
- 用户主动退出登录后重新登录可正常访问
- 密码验证成功后能正确跳转回原页面
- 后台可以查看完整的锁定/解锁记录
- 路由配置支持精确匹配和通配符匹配

### 2. 技术验收

- 代码符合 PSR-12 编码规范
- 所有服务正确注册到 Symfony 容器
- Twig 扩展不影响原有模板渲染
- JavaScript 代码不与现有前端框架冲突
- 数据库迁移文件正确生成

### 3. 性能验收

- 前端活动检测不影响页面性能
- 数据库查询已优化（添加必要索引）
- 锁定检查中间件响应时间 < 50ms

### 4. 安全验收

- 密码验证使用安全的哈希算法
- 防止时序攻击和暴力破解
- 锁定状态无法通过客户端篡改绕过
- 敏感信息不在前端暴露

## 特殊备注说明

### 技术难点与解决方案

1. **Twig 无侵入集成**：通过 Twig Extension 在页面底部自动注入 JavaScript，避免修改现有模板
2. **锁定状态持久化**：使用数据库存储锁定状态，结合 Session ID 和用户 ID 双重验证
3. **路由匹配灵活性**：支持正则表达式和通配符，满足不同场景的配置需求
4. **前端性能优化**：使用防抖技术减少不必要的活动检测触发

### 风险评估

- **兼容性风险**：可能与现有 JavaScript 框架产生冲突 → 使用命名空间隔离
- **性能风险**：频繁的活动检测可能影响性能 → 合理设置检测间隔
- **安全风险**：锁定机制被绕过 → 多层验证确保安全性

### 后续扩展计划

- 支持多种解锁方式（指纹、短信验证码等）
- 集成企业级单点登录（SSO）
- 支持移动端适配
- 添加锁定统计和分析功能
