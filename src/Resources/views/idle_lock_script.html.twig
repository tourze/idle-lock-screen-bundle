<script type="text/javascript">
(function() {
    'use strict';
    
    // 无操作锁定命名空间
    window.IdleLock = window.IdleLock || {};
    
    // 配置
    const config = {
        timeout: {{ timeoutMs }},
        lockUrl: '{{ lockUrl }}',
        currentRoute: '{{ route }}',
        checkInterval: 1000, // 每秒检查一次
        debounceDelay: 300   // 防抖延迟
    };
    
    let lastActivity = Date.now();
    let isLocked = false;
    let checkTimer = null;
    let debounceTimer = null;
    
    // 活动事件列表
    const activityEvents = [
        'mousedown', 'mousemove', 'keypress', 'scroll', 
        'touchstart', 'click', 'focus', 'blur'
    ];
    
    // 重置活动时间（防抖处理）
    function resetActivity() {
        if (debounceTimer) {
            clearTimeout(debounceTimer);
        }
        
        debounceTimer = setTimeout(function() {
            lastActivity = Date.now();
        }, config.debounceDelay);
    }
    
    // 检查是否超时
    function checkTimeout() {
        if (isLocked) {
            return;
        }
        
        const now = Date.now();
        const timeSinceLastActivity = now - lastActivity;
        
        if (timeSinceLastActivity >= config.timeout) {
            lockScreen();
        }
    }
    
    // 锁定屏幕
    function lockScreen() {
        if (isLocked) {
            return;
        }
        
        isLocked = true;
        
        // 停止检查定时器
        if (checkTimer) {
            clearInterval(checkTimer);
            checkTimer = null;
        }
        
        // 发送锁定请求到服务器
        fetch(config.lockUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                route: config.currentRoute,
                timestamp: Date.now()
            })
        }).then(function(response) {
            if (response.ok) {
                // 跳转到锁定页面
                window.location.href = config.lockUrl + '?redirect=' + encodeURIComponent(window.location.href);
            }
        }).catch(function(error) {
            console.error('IdleLock: Failed to lock session', error);
            // 即使请求失败也跳转到锁定页面
            window.location.href = config.lockUrl + '?redirect=' + encodeURIComponent(window.location.href);
        });
    }
    
    // 初始化
    function init() {
        // 绑定活动事件
        activityEvents.forEach(function(event) {
            document.addEventListener(event, resetActivity, true);
        });
        
        // 启动检查定时器
        checkTimer = setInterval(checkTimeout, config.checkInterval);
        
        // 初始化活动时间
        resetActivity();
        
        console.log('IdleLock: Initialized with timeout', config.timeout + 'ms');
    }
    
    // 清理函数
    function cleanup() {
        if (checkTimer) {
            clearInterval(checkTimer);
            checkTimer = null;
        }
        
        if (debounceTimer) {
            clearTimeout(debounceTimer);
            debounceTimer = null;
        }
        
        activityEvents.forEach(function(event) {
            document.removeEventListener(event, resetActivity, true);
        });
    }
    
    // 暴露公共接口
    window.IdleLock.init = init;
    window.IdleLock.cleanup = cleanup;
    window.IdleLock.resetActivity = resetActivity;
    window.IdleLock.isLocked = function() { return isLocked; };
    
    // 页面加载完成后初始化
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
    
    // 页面卸载时清理
    window.addEventListener('beforeunload', cleanup);
    
})();
</script>